<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventario por Voz</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; color: #222; }
  h1 { font-size: 1.4em; }
  button { padding: 10px 20px; margin: 10px 5px; font-size: 1em; }
  table { border-collapse: collapse; width: 100%; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #eee; }
  #status { margin-top: 10px; color: #007b00; font-weight: bold; }
  button.btn-eliminar {
    padding: 3px 8px;
    font-size: 0.9em;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>üì¶ Inventario por Voz</h1>

<button id="startBtn">üéô Hablar</button>
<button id="exportBtn">‚¨á Exportar a Excel</button>
<button id="resetBtn">üîÑ Resetear inventario</button>
<div id="status"></div>

<table id="tabla">
  <thead>
    <tr><th>√çtem</th><th>Cantidad</th><th>Acci√≥n</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let items = ["Shaman ipa", "Pachacutec", "Troglo red", "Troglo ipa", "Chimay"];
let inventario = JSON.parse(localStorage.getItem("inventario_voz")) || {};
items.forEach(i => { if (!(i in inventario)) inventario[i] = 0; });

const tabla = document.querySelector("#tabla tbody");
const status = document.getElementById("status");

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;

if (!SpeechRecognition) {
  status.textContent = "‚ö†Ô∏è Este navegador no soporta reconocimiento de voz. Usa Chrome en PC para mejor experiencia.";
  document.getElementById("startBtn").disabled = true;
}

function actualizarTabla() {
  tabla.innerHTML = "";
  for (let item of items) {
    let row = `
      <tr>
        <td>${item}</td>
        <td>${inventario[item]}</td>
        <td><button class="btn-eliminar" data-item="${item}">üóë</button></td>
      </tr>`;
    tabla.innerHTML += row;
  }

  // Agregar eventos a los botones eliminar
  document.querySelectorAll(".btn-eliminar").forEach(btn => {
    btn.onclick = () => {
      let nombre = btn.getAttribute("data-item");
      eliminarItem(nombre);
    };
  });

  localStorage.setItem("inventario_voz", JSON.stringify(inventario));
}
actualizarTabla();

function agregarItem(nuevo) {
  if (!nuevo) return;
  nuevo = nuevo.trim();
  if (items.find(i => i.toLowerCase() === nuevo.toLowerCase())) {
    status.textContent = `‚ö†Ô∏è ${nuevo} ya existe`;
    return;
  }
  items.push(nuevo);
  inventario[nuevo] = 0;
  status.textContent = `üÜï Agregado producto: ${nuevo}`;
  actualizarTabla();
}

function eliminarItem(nombre) {
  nombre = nombre.trim().toLowerCase();
  const encontrado = items.find(i => i.toLowerCase() === nombre);
  if (!encontrado) {
    status.textContent = `‚ùå No se encontr√≥ ${nombre}`;
    return;
  }
  items = items.filter(i => i.toLowerCase() !== nombre);
  delete inventario[encontrado];
  status.textContent = `üóë Producto eliminado: ${encontrado}`;
  actualizarTabla();
}

function procesarTexto(texto) {
  texto = texto.toLowerCase().trim();

  // Comando para agregar producto
  if (texto.startsWith("agregar producto")) {
    let nuevo = texto.replace("agregar producto", "").trim();
    if (nuevo.length > 0) agregarItem(nuevo);
    else status.textContent = "‚ùå No se entendi√≥ el nombre del nuevo producto";
    return;
  }

  // Comando para eliminar producto
  if (texto.startsWith("eliminar producto")) {
    let nombre = texto.replace("eliminar producto", "").trim();
    if (nombre.length > 0) eliminarItem(nombre);
    else status.textContent = "‚ùå No se entendi√≥ qu√© producto eliminar";
    return;
  }

  // Buscar √≠tem existente
  let encontrado = items.find(i => texto.includes(i.toLowerCase()));
  if (!encontrado) {
    status.textContent = "‚ùå √çtem no reconocido";
    return;
  }

  let numero = parseInt(texto.match(/\d+/));
  if (isNaN(numero)) {
    status.textContent = "‚ùå No se detect√≥ cantidad";
    return;
  }

  // Operaciones
  if (texto.includes("m√°s")) {
    inventario[encontrado] += numero;
    status.textContent = `‚ûï Sumado ${numero} a ${encontrado}`;
  } else if (texto.includes("menos")) {
    inventario[encontrado] -= numero;
    if (inventario[encontrado] < 0) inventario[encontrado] = 0;
    status.textContent = `‚ûñ Restado ${numero} de ${encontrado}`;
  } else {
    inventario[encontrado] = numero;
    status.textContent = `‚úÖ ${encontrado}: ${numero}`;
  }

  actualizarTabla();
}

document.getElementById("startBtn").onclick = () => {
  if (!SpeechRecognition) {
    status.textContent = "‚ö†Ô∏è Este navegador no soporta reconocimiento de voz.";
    document.getElementById("startBtn").disabled = true;
    return;
  }

  let recog;
  try {
    recog = new SpeechRecognition();
  } catch (e) {
    status.textContent = "‚ö†Ô∏è No se pudo iniciar el reconocimiento de voz.";
    document.getElementById("startBtn").disabled = true;
    return;
  }

  recog.lang = "es-ES";

  recog.onerror = (event) => {
    // Mensajes comunes para incompatibilidad o permisos
    if (event.error === "not-allowed" || event.error === "service-not-allowed") {
      status.textContent = "‚ö†Ô∏è Permiso para usar micr√≥fono denegado.";
      document.getElementById("startBtn").disabled = true;
    } else if (event.error === "no-speech" || event.error === "aborted") {
      status.textContent = "‚ö†Ô∏è No se detect√≥ voz o se cancel√≥.";
    } else {
      status.textContent = "‚ö†Ô∏è Error al escuchar: " + event.error;
    }
  };

  recog.onstart = () => {
    status.textContent = "üé§ Escuchando...";
  };

  recog.onresult = (event) => {
    const texto = event.results[0][0].transcript;
    procesarTexto(texto);
  };

  try {
    recog.start();
  } catch (e) {
    status.textContent = "‚ö†Ô∏è Error al iniciar el reconocimiento de voz.";
  }
};

document.getElementById("exportBtn").onclick = () => {
  let fecha = new Date().toISOString().slice(0,10);
  let ws_data = [["√çtem", "Cantidad"]];
  for (let item of items) ws_data.push([item, inventario[item]]);
  let wb = XLSX.utils.book_new();
  let ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Inventario");
  XLSX.writeFile(wb, `inventario_${fecha}.xlsx`);
};

document.getElementById("resetBtn").onclick = () => {
  for (let item of items) {
    inventario[item] = 0;
  }
  status.textContent = "üîÑ Inventario reseteado";
  actualizarTabla();
};
</script>

</body>
</html>
